name: Process Bilingual Content

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '*.md'

# Add explicit permissions for the workflow
permissions:
  contents: write
  actions: read

jobs:
  process-bilingual:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.4'
        # Remove bundler-cache to avoid github-pages gem conflicts
        bundler-cache: false
    
    - name: Find and process bilingual files
      run: |
        echo "🔍 Looking for bilingual markdown files..."
        
        # Initialize counter
        processed_count=0
        
        # Process files individually to avoid shell issues
        while IFS= read -r -d '' file; do
          if [ -f "$file" ] && grep -q "bilingual: true" "$file"; then
            echo "📋 Found bilingual file: $file"
            
            # Check if file contains :::lang: syntax
            if grep -q ":::lang:" "$file"; then
              echo "🔄 Processing: $file (found :::lang: syntax)"
              
              # Create backup
              cp "$file" "${file}.backup"
              
              # Process the file using Ruby directly (no bundler)
              if ruby scripts/bilingual_preprocessor.rb "$file"; then
                echo "  ✅ Successfully processed $file"
                processed_count=$((processed_count + 1))
              else
                echo "  ❌ Failed to process $file, restoring backup"
                mv "${file}.backup" "$file"
              fi
              
              # Clean up backup if processing succeeded
              [ -f "${file}.backup" ] && rm "${file}.backup"
            else
              echo "  → No :::lang: syntax found in $file, skipping"
            fi
          fi
        done < <(find . -name "*.md" -not -path "./_site/*" -not -path "./vendor/*" -print0)
        
        echo "📊 Processed $processed_count files"
        echo "PROCESSED_COUNT=$processed_count" >> $GITHUB_ENV
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if git diff --quiet; then
          echo "No changes detected after processing"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected after processing"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          echo "📋 Changed files:"
          git diff --name-only
          
          echo "📝 Sample of changes:"
          git diff --unified=3 | head -50
        fi
    
    - name: Commit and push processed files
      if: steps.verify-changed-files.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        
        # Create single-line commit message to avoid issues
        git commit -m "🤖 Auto-process bilingual content - Converted :::lang: syntax to HTML divs [skip ci]"
        
        # Push directly using git
        git push origin main
    
    - name: Summary
      run: |
        echo "📊 Processing summary:"
        if [ "${PROCESSED_COUNT:-0}" -gt 0 ]; then
          echo "🎉 Successfully processed ${PROCESSED_COUNT:-0} bilingual files"
          echo "✨ Files are now ready for Jekyll to build with proper HTML structure"
        else
          echo "📝 No bilingual files needed processing"
        fi 